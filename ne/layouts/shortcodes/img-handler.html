{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" | default "" -}}
{{- $class := .Get "class" | default "" -}}
{{- $responsive := .Get "responsive" | default "false" | lower -}}
{{- $webp := .Get "webp" | default "false" | lower -}}
{{- $img := .Page.Resources.GetMatch $src -}}

{{- if not $img }}
  <img src="#" alt="Missing image: {{ $src }}" class="{{ $class }}" />
{{- else if eq $responsive "true" }}
  {{- $widths := slice 320 640 960 1280 1600 -}}
  {{- $srcset := slice -}}
  {{- range $w := $widths }}
    {{- $sized := $img.Fit (printf "%dx0" $w) -}}
    {{- $srcset = $srcset | append (printf "%s %dw" $sized.RelPermalink $w) -}}
  {{- end }}

  {{- $fallback := $img.Fit "640x0" -}}

  {{- if eq $webp "true" }}
    <picture>
      <source 
        type="image/webp"
        srcset="{{ delimit (slice (printf "%s 1x" ($img.Convert "webp").RelPermalink)) ", " }}"
      >
      <img 
        src="{{ $fallback.RelPermalink }}"
        srcset="{{ delimit $srcset ", " }}"
        sizes="(max-width: 640px) 100vw, 640px"
        alt="{{ $alt }}"
        class="{{ $class }}"
        loading="lazy"
        decoding="async"
        width="{{ $fallback.Width }}"
        height="{{ $fallback.Height }}"
      />
    </picture>
  {{- else }}
    <img 
      src="{{ $fallback.RelPermalink }}"
      srcset="{{ delimit $srcset ", " }}"
      sizes="(max-width: 640px) 100vw, 640px"
      alt="{{ $alt }}"
      class="{{ $class }}"
      loading="lazy"
      decoding="async"
      width="{{ $fallback.Width }}"
      height="{{ $fallback.Height }}"
    />
  {{- end }}

{{- else }}
  <img 
    src="{{ $img.RelPermalink }}"
    alt="{{ $alt }}"
    class="{{ $class }}"
    loading="lazy"
    decoding="async"
    width="{{ $img.Width }}"
    height="{{ $img.Height }}"
  />
{{- end }}
